<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rocell Gadget | Katalog HP</title>
<meta name="description" content="Rocell Gadget - Jual beli HP aman & terpercaya" />
<link rel="icon" href="rocell_gadget_logo.png" />

<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
:root{
  --bg:#ffffff;
  --card-bg:#f8fafc;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
  --danger:#dc2626;
  --wa:#22c55e;
}
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg);
  color:var(--text);
}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:55px}
.brand h1{margin:0;font-size:1.25rem}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:16px;
}
.card-product{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.card-product img{width:100%;height:180px;object-fit:contain;background:#fff}
.card-product .info{padding:12px;flex:1}
.card-product h3{margin:0 0 6px;font-size:1rem}
.price{font-weight:700;color:var(--accent);margin-bottom:8px}
.card-product .wa-link{
  margin:0 12px 12px;
  text-align:center;
  background:var(--wa);
  color:#fff;
  padding:10px;
  border-radius:6px;
  text-decoration:none;
  font-weight:600;
  display:block;
}
.admin-actions{display:flex;gap:8px;padding:0 12px 12px}
.admin-actions .btn{ flex: 1; }
.hidden{display:none}
.wa-float{position:fixed;right:16px;bottom:16px;background:var(--wa);color:#fff;padding:12px 16px;border-radius:999px;text-decoration:none;font-weight:600;z-index:99}
footer{margin:32px 0;text-align:center;color:var(--muted);font-size:13px}
#adminToolbar { padding: 16px; border: 1px solid var(--border); border-radius: 12px; }
.modal-content { background: #fff; color: var(--text); }
.form-control { background-color: #f3f4f6; border-color: var(--border); }
.form-control:focus { background-color: #fff; }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>

<body>

<div class="container">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <div class="brand">
      <img src="rocell_gadget_logo.png" alt="Rocell Gadget">
      <h1>Rocell Gadget</h1>
    </div>
    <div>
      <button id="loginBtn" class="btn btn-outline-primary">Login Admin</button>
      <button id="logoutBtn" class="btn btn-outline-secondary hidden">Logout</button>
    </div>
  </header>

  <div id="adminToolbar" class="admin hidden mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Panel Admin</h5>
        <button id="addBtn" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Tambah Barang</button>
    </div>
  </div>

  <div id="produk" class="grid"></div>

  <footer>
    © Rocell Gadget · Jual Beli HP Aman & Terpercaya
  </footer>
</div>

<a class="wa-float" target="_blank" href="https://wa.me/6281211172228">
  <i class="bi bi-whatsapp"></i> WhatsApp
</a>

<!-- Modal -->
<div class="modal fade" id="modalItem" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalItemTitle">Tambah Produk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="mId" />
        <input type="hidden" id="mGambarLama" />
        <div class="mb-2"><label class="form-label">Nama</label><input id="mNama" class="form-control" /></div>
        <div class="mb-2"><label class="form-label">Harga (Rp)</label><input id="mHarga" type="number" class="form-control" value="0" min="0" /></div>
        <div class="mb-2">
            <label class="form-label">Foto</label>
            <input id="mGambar" type="file" class="form-control" accept="image/*" />
            <div class="form-text">Kosongkan jika tidak ingin mengubah foto.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button id="btnSaveItem" class="btn btn-primary">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAcLq0OpLMY9gfOVb7854pzaEAjqNbgHGs",
  authDomain: "rocellgadget.firebaseapp.com",
  projectId: "rocellgadget",
  storageBucket: "rocellgadget.appspot.com",
  messagingSenderId: "451065886878",
  appId: "1:451065886878:web:e3f291259be532f8a5638f"
};
const ADMIN_EMAIL = "mahakaryahutama.corp@gmail.com";

// Helper
const el = id => document.getElementById(id);

// Init Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let itemModal;


// Auth state
auth.onAuthStateChanged(user => {
  const isAdmin = user && user.email === ADMIN_EMAIL;
  el('adminToolbar').classList.toggle("hidden", !isAdmin);
  el('loginBtn').classList.toggle("hidden", isAdmin);
  el('logoutBtn').classList.toggle("hidden", !isAdmin);
  loadProducts(); // Reload products to show/hide admin buttons
});

// Load products
db.collection("items").orderBy("createdAt", "desc")
.onSnapshot(snap => {
  const produkContainer = el('produk');
  produkContainer.innerHTML = "";
  snap.forEach(doc => {
    const item = { id: doc.id, ...doc.data() };
    const harga = "Rp " + (item.harga || 0).toLocaleString("id-ID");
    const pesan = encodeURIComponent(
      `Halo Rocell Gadget, saya tertarik dengan ${item.nama} (${harga})`
    );
    const isAdmin = auth.currentUser && auth.currentUser.email === ADMIN_EMAIL;

    const card = document.createElement('div');
    card.className = 'card-product';
    card.innerHTML = `
      <img src="${item.gambar || 'https://via.placeholder.com/300?text=Rocell+Gadget'}">
      <div class="info">
        <h3>${item.nama}</h3>
        <div class="price">${harga}</div>
      </div>
      <a class="wa-link" target="_blank" href="https://wa.me/6281211172228?text=${pesan}">
        <i class="bi bi-whatsapp"></i> Chat WhatsApp
      </a>
      ${isAdmin ? `
      <div class="admin-actions">
        <button class="btn btn-outline-secondary btn-sm" onclick="openModal('${item.id}')">Edit</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="changePhoto('${item.id}', '${item.gambar || ''}')">Ubah Foto</button>
        <button class="btn btn-outline-danger btn-sm" onclick="deleteItem('${item.id}', '${item.gambar || ''}')">Hapus</button>
      </div>` : ""}
    `;
    produkContainer.appendChild(card);
  });
});

// CRUD Functions
function openModal(id = null) {
  itemModal.show();
  const isEdit = id !== null;
  el('modalItemTitle').textContent = isEdit ? 'Edit Produk' : 'Tambah Produk';
  
  if (isEdit) {
    db.collection('items').doc(id).get().then(doc => {
      if (!doc.exists) return alert('Barang tidak ditemukan!');
      const item = doc.data();
      el('mId').value = id;
      el('mNama').value = item.nama;
      el('mHarga').value = item.harga;
      el('mGambarLama').value = item.gambar || '';
    });
  } else {
    el('mId').value = '';
    el('mNama').value = '';
    el('mHarga').value = '';
    el('mGambarLama').value = '';
    el('mGambar').value = '';
  }
}

async function saveItem() {
  const id = el('mId').value;
  const nama = el('mNama').value.trim();
  const harga = Number(el('mHarga').value);
  const file = el('mGambar').files[0];
  const gambarLama = el('mGambarLama').value;

  if (!nama || !harga) return alert("Nama & harga wajib diisi");

  try {
    let newImageUrl = gambarLama;
    // Handle file upload
    if (file) {
      if (id && gambarLama) {
        try { await storage.refFromURL(gambarLama).delete(); } catch (e) { console.warn("Could not delete old image", e.message); }
      }
      const ref = storage.ref("produk/" + Date.now() + "_" + file.name);
      const snap = await ref.put(file);
      newImageUrl = await snap.ref.getDownloadURL();
    }

    const data = {
      nama,
      harga,
      gambar: newImageUrl
    };

    if (id) { // Update
      await db.collection("items").doc(id).update(data);
    } else { // Create
      data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      await db.collection("items").add(data);
    }

    itemModal.hide();
    el('mGambar').value = '';
  } catch (err) {
    console.error(err);
    alert("Gagal menyimpan barang. Lihat console untuk detail.");
  }
}

async function deleteItem(id, imageUrl) {
  if (!confirm("Hapus barang ini?")) return;
  try {
    await db.collection("items").doc(id).delete();
    if (imageUrl) {
      await storage.refFromURL(imageUrl).delete();
    }
  } catch (err) {
    console.error(err);
    alert("Gagal menghapus barang. Lihat console untuk detail.");
  }
}

async function changePhoto(id, oldImageUrl) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        alert('Mengunggah foto baru... Proses ini mungkin memerlukan waktu beberapa saat.');
        
        try {
            const newImageRef = storage.ref("produk/" + Date.now() + "_" + file.name);
            const uploadSnap = await newImageRef.put(file);
            const newImageUrl = await uploadSnap.ref.getDownloadURL();

            await db.collection("items").doc(id).update({ gambar: newImageUrl });

            if (oldImageUrl) {
                try {
                    await storage.refFromURL(oldImageUrl).delete();
                } catch (storageErr) {
                    console.warn("Gagal menghapus foto lama:", storageErr.message);
                }
            }
            alert('Foto berhasil diperbarui!');
        } catch (err) {
            console.error("Gagal mengubah foto:", err);
            alert("Gagal mengubah foto. Lihat console untuk detail.");
        }
    };
    input.click();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    itemModal = new bootstrap.Modal(el('modalItem'));
    el('loginBtn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    el('logoutBtn').onclick = () => auth.signOut();
    el('addBtn').onclick = () => openModal();
    el('btnSaveItem').onclick = saveItem;
});
</script>

</body>
</html>
